# 产品需求文档：提交嵌入任务 - 检查文件流程

## 1. 需求概述

本文档基于 [`docs/function_document.md`](docs/function_document.md:63-66) 中"提交嵌入任务"处理流程的"检查文件"环节，使用 EARS（Easy Approach to Requirements Syntax）需求语法详细描述该流程的功能需求。

## 2. EARS 需求描述

### 2.1 需求类型
**事件控制型需求 (Event-Controlled Requirement)**

### 2.2 详细需求描述

**事件 (Event):**
当系统完成ZIP文件解压并成功读取 `.shenma_sync` 文件夹中的同步元数据文件后触发。

**控制条件 (Control):**
系统必须对解压后的实际文件列表与同步元数据文件中记录的待处理文件进行一致性验证。

**状态 (State):**
- 同步元数据文件已解析完成
- 解压后的文件目录结构已建立
- 同步元数据中包含 "fileList" 字段，其中包含 "add" 和 "modify" 操作标记的文件路径

**响应 (Response):**
系统必须执行以下操作序列：

1. **文件存在性验证**
   - 遍历同步元数据中 "fileList" 下的所有 "add" 操作标记的文件路径
   - 遍历同步元数据中 "fileList" 下的所有 "modify" 操作标记的文件路径
   - 验证每个标记的文件路径是否存在于解压后的文件目录结构中

2. **匹配结果记录**
   - 对每个验证的文件路径，记录其匹配状态（成功/失败）
   - 对于匹配失败的文件，必须记录具体的文件路径和失败原因
   - 生成完整的匹配结果摘要，包括：
     - 总验证文件数
     - 成功匹配数
     - 匹配失败数
     - 失败文件列表

3. **日志输出**
   - 将匹配结果以结构化格式输出到系统日志
   - 日志级别：INFO
   - 日志内容必须包含：
     - 验证时间戳
     - 代码库标识（clientId + codebasePath）
     - 匹配结果摘要
     - 失败文件详情（如存在）

## 3. 功能边界

### 3.1 包含范围
- 验证同步元数据中标记为 "add" 的文件
- 验证同步元数据中标记为 "modify" 的文件
- 记录所有验证结果到日志系统

### 3.2 排除范围
- 不处理标记为 "delete" 的文件（这些文件已在之前的步骤中处理）
- 不执行实际的文件内容处理（仅做存在性检查）
- 不修改同步元数据文件内容
- 不中断主流程（即使存在匹配失败的情况）

## 4. 验收标准

### 4.1 功能验收
- [ ] 能够正确读取并解析同步元数据文件
- [ ] 能够准确匹配元数据中指定的文件路径与实际文件
- [ ] 能够生成完整的匹配结果报告
- [ ] 能够将结果正确记录到系统日志

### 4.2 性能验收
- [ ] 文件验证过程应在1秒内完成（对于常规大小的代码库）
- [ ] 日志记录不应影响主流程性能

### 4.3 错误处理
- [ ] 当同步元数据格式错误时，记录错误日志但不中断流程
- [ ] 当文件系统访问失败时，记录具体错误信息
- [ ] 对于不存在的文件路径，明确标记为匹配失败

## 5. 备注

此需求是"提交嵌入任务"整体流程中的一个关键环节，其目的是确保同步元数据的准确性，为后续的代码嵌入处理提供可靠的数据基础。该检查流程的结果仅用于信息记录和调试目的，不应影响主流程的执行。