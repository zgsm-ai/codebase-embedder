# 需求规格说明书 - Codebase Embedder RESTful接口测试方案

## 1. 项目概述

### 1.1 背景
Codebase Embedder是一个代码库嵌入和语义搜索系统，提供基于向量化技术的代码片段检索能力。系统通过RESTful API为开发者提供代码索引、语义搜索、索引管理等功能。

### 1.2 目标
- 确保所有RESTful接口的功能完整性和正确性
- 建立全面的接口测试体系，覆盖功能、性能、安全性和兼容性维度
- 制定可执行的验收标准，保证接口质量
- 识别并规避潜在的技术和业务风险

### 1.3 范围
本文档涵盖Codebase Embedder系统提供的4个核心RESTful接口的测试需求定义，包括接口端点说明、测试场景分类、验收标准和风险分析。

## 2. 接口端点说明

### 2.1 语义搜索接口
- **端点**: GET /codebase-embedder/api/v1/search/semantic
- **功能**: 基于自然语言查询的代码语义搜索
- **参数**:
  - clientId: 用户机器ID（必填，字符串）
  - codebasePath: 项目绝对路径（必填，字符串）
  - query: 查询内容（必填，字符串）
  - topK: 结果返回数量（选填，整数，默认10）

### 2.2 索引摘要接口
- **端点**: GET /codebase-embedder/api/v1/embeddings/summary
- **功能**: 获取代码库索引状态和统计信息
- **参数**:
  - clientId: 用户机器ID（必填，字符串）
  - codebasePath: 项目绝对路径（必填，字符串）

### 2.3 创建索引接口
- **端点**: POST /codebase-embedder/api/v1/embeddings
- **功能**: 触发代码库向量化索引任务
- **请求体**:
  - clientId: 用户机器ID（必填，字符串）
  - codebasePath: 项目绝对路径（必填，字符串）

### 2.4 删除索引接口
- **端点**: DELETE /codebase-embedder/api/v1/embeddings
- **功能**: 删除指定代码库或文件的索引数据
- **参数**:
  - clientId: 用户机器ID（必填，字符串）
  - codebasePath: 项目绝对路径（必填，字符串）
  - filePaths: 要删除的文件路径列表（必填，字符串）

## 3. 测试场景分类

### 3.1 功能测试场景

#### 3.1.1 语义搜索功能测试
- **场景ID**: FT-SS-001
- **EARS描述**: 
  - **E**vent: 当用户提交有效的语义搜索请求时
  - **A**ction: 系统应该返回匹配的代码片段列表
  - **R**esult: 返回结果包含代码内容、文件路径和匹配得分
  - **S**takeholder: 使用语义搜索功能的开发者

- **场景ID**: FT-SS-002
- **EARS描述**:
  - **E**vent: 当用户提交无效的查询参数时
  - **A**ction: 系统应该返回相应的错误信息
  - **R**esult: 错误信息明确指出参数问题
  - **S**takeholder: API调用者

#### 3.1.2 索引管理功能测试
- **场景ID**: FT-IM-001
- **EARS描述**:
  - **E**vent: 当用户请求创建代码库索引时
  - **A**ction: 系统应该启动异步索引任务
  - **R**esult: 返回任务ID用于状态跟踪
  - **S**takeholder: 需要索引代码库的开发者

- **场景ID**: FT-IM-002
- **EARS描述**:
  - **E**vent: 当用户查询索引状态时
  - **A**ction: 系统应该返回当前索引状态和统计信息
  - **R**esult: 显示总文件数、索引块数、最后更新时间
  - **S**takeholder: 监控索引进度的运维人员

### 3.2 性能测试场景

#### 3.2.1 搜索性能测试
- **场景ID**: PT-SS-001
- **EARS描述**:
  - **E**vent: 当系统接收到高并发搜索请求时
  - **A**ction: 系统应该在规定时间内响应
  - **R**esult: 95%的请求响应时间不超过2秒
  - **S**takeholder: 高频使用搜索功能的用户

- **场景ID**: PT-SS-002
- **EARS描述**:
  - **E**vent: 当搜索大型代码库时
  - **A**ction: 系统应该有效利用缓存和索引
  - **R**esult: 搜索响应时间与代码库大小呈次线性关系
  - **S**takeholder: 处理大型项目的开发者

#### 3.2.2 索引性能测试
- **场景ID**: PT-IM-001
- **EARS描述**:
  - **E**vent: 当索引包含10万文件的代码库时
  - **A**ction: 系统应该合理分配资源完成索引
  - **R**esult: 索引完成时间不超过4小时
  - **S**takeholder: 首次使用系统的用户

### 3.3 安全性测试场景

#### 3.3.1 输入验证测试
- **场景ID**: ST-IV-001
- **EARS描述**:
  - **E**vent: 当用户提交包含恶意代码的路径参数时
  - **A**ction: 系统应该进行严格的输入验证和过滤
  - **R**esult: 拒绝恶意请求并记录安全日志
  - **S**takeholder: 系统安全管理员

#### 3.3.2 权限控制测试
- **场景ID**: ST-PC-001
- **EARS描述**:
  - **E**vent: 当未授权用户尝试访问其他用户的代码库时
  - **A**ction: 系统应该验证clientId与代码库的关联关系
  - **R**esult: 拒绝越权访问并返回403错误
  - **S**takeholder: 多用户环境下的系统管理员

### 3.4 兼容性测试场景

#### 3.4.1 路径兼容性测试
- **场景ID**: CT-PC-001
- **EARS描述**:
  - **E**vent: 当用户使用不同操作系统的路径格式时
  - **A**ction: 系统应该正确处理Windows、Linux、macOS路径
  - **R**esult: 所有平台的路径都能被正确解析和处理
  - **S**takeholder: 跨平台开发团队

#### 3.4.2 编码兼容性测试
- **场景ID**: CT-EC-001
- **EARS描述**:
  - **E**vent: 当代码库包含不同编码格式的文件时
  - **A**ction: 系统应该支持UTF-8、GBK等常见编码
  - **R**esult: 所有编码的文件都能被正确索引和搜索
  - **S**takeholder: 国际化开发团队

## 4. 验收标准

### 4.1 功能验收标准

| 测试维度 | 验收标准 | 测量方法 | 通过阈值 |
|----------|----------|----------|----------|
| 语义搜索准确性 | 返回结果的相关性 | 人工评估Top10结果 | 80%以上相关 |
| 索引完整性 | 索引文件覆盖率 | 对比文件系统与索引记录 | 100%覆盖 |
| 数据一致性 | 索引状态准确性 | 实时状态与摘要信息对比 | 100%一致 |
| 错误处理 | 错误信息清晰度 | 错误场景测试 | 错误信息可理解 |

### 4.2 性能验收标准

| 性能指标 | 目标值 | 测试条件 | 测量方法 |
|----------|--------|----------|----------|
| 搜索响应时间 | ≤2秒 | 100并发用户 | P95响应时间 |
| 索引吞吐量 | ≥100文件/分钟 | 标准代码库 | 平均处理速度 |
| 系统资源使用 | CPU≤80%, 内存≤4GB | 峰值负载 | 系统监控 |
| 并发处理能力 | ≥50并发搜索 | 持续30分钟 | 成功率≥99% |

### 4.3 安全验收标准

| 安全要求 | 验收标准 | 测试方法 | 通过条件 |
|----------|----------|----------|----------|
| 输入验证 | 拒绝所有恶意输入 | SQL注入、路径遍历测试 | 0个安全漏洞 |
| 权限控制 | 防止越权访问 | 横向权限测试 | 100%拦截 |
| 数据保护 | 敏感信息不泄露 | 日志审计、响应检查 | 无敏感信息暴露 |
| 审计日志 | 所有操作可追踪 | 日志完整性检查 | 100%操作记录 |

### 4.4 兼容性验收标准

| 兼容性要求 | 验收标准 | 测试环境 | 通过条件 |
|------------|----------|----------|----------|
| 操作系统兼容 | 支持Win/Linux/macOS | 3种OS环境测试 | 功能一致性100% |
| 路径格式兼容 | 支持不同路径分隔符 | 路径边界测试 | 100%正确处理 |
| 编码格式兼容 | 支持UTF-8/GBK/ASCII | 多编码文件测试 | 无乱码或错误 |
| API版本兼容 | 向后兼容旧版本 | 版本升级测试 | 无破坏性变更 |

## 5. 潜在风险点

### 5.1 技术风险

| 风险描述 | 风险等级 | 影响范围 | 缓解策略 |
|----------|----------|----------|----------|
| 向量数据库性能瓶颈 | 高 | 搜索响应时间 | 实施分片策略和缓存机制 |
| 大文件处理内存溢出 | 中 | 系统稳定性 | 实现流式处理和内存限制 |
| 并发索引资源竞争 | 中 | 任务处理效率 | 实施任务队列和资源隔离 |
| 网络超时导致索引失败 | 低 | 数据完整性 | 增加重试机制和断点续传 |

### 5.2 业务风险

| 风险描述 | 风险等级 | 影响范围 | 缓解策略 |
|----------|----------|----------|----------|
| 用户误删重要索引数据 | 高 | 数据丢失 | 实施软删除和定期备份 |
| 敏感代码泄露风险 | 高 | 信息安全 | 加强访问控制和数据加密 |
| 索引结果不准确影响开发效率 | 中 | 用户体验 | 建立质量监控和反馈机制 |
| 系统不可用影响开发流程 | 中 | 业务连续性 | 实施高可用架构和降级策略 |

### 5.3 测试风险

| 风险描述 | 风险等级 | 影响范围 | 缓解策略 |
|----------|----------|----------|----------|
| 测试环境与生产环境差异 | 中 | 测试结果准确性 | 建立与生产一致的测试环境 |
| 边界场景测试覆盖不足 | 中 | 系统稳定性 | 制定边界值测试用例集 |
| 性能测试数据不真实 | 低 | 性能评估准确性 | 使用真实代码库样本测试 |
| 安全测试工具误报 | 低 | 测试效率 | 建立安全测试白名单机制 |

## 6. 测试数据需求

### 6.1 功能测试数据
- 标准代码库：包含多种语言（Go、Java、Python、JavaScript）的示例项目
- 边界测试数据：空文件、超大文件（>10MB）、特殊字符文件名
- 错误测试数据：无效路径、超长查询字符串、特殊字符注入

### 6.2 性能测试数据
- 小型代码库：100-1000个文件
- 中型代码库：1000-10000个文件
- 大型代码库：10000-50000个文件
- 超大型代码库：>50000个文件

### 6.3 安全测试数据
- SQL注入测试字符串
- 路径遍历测试路径
- XSS攻击载荷
- 命令注入测试数据

## 7. 测试环境需求

### 7.1 硬件环境
- CPU: 8核心以上
- 内存: 16GB以上
- 存储: SSD 100GB以上可用空间
- 网络: 千兆网络连接

### 7.2 软件环境
- 操作系统: Ubuntu 20.04 LTS / Windows 10 / macOS 12
- 容器环境: Docker 20.10+
- 数据库: PostgreSQL 13+
- 缓存: Redis 6+
- 向量数据库: Weaviate 1.18+

### 7.3 测试工具
- 接口测试: Postman/Newman
- 性能测试: JMeter/k6
- 安全测试: OWASP ZAP/Burp Suite
- 持续集成: Jenkins/GitHub Actions

## 8. 交付物清单

- [ ] 接口测试用例文档（包含所有EARS场景）
- [ ] 测试数据准备清单
- [ ] 测试环境配置指南
- [ ] 自动化测试脚本
- [ ] 性能测试报告模板
- [ ] 安全测试报告模板
- [ ] 测试执行计划
- [ ] 风险评估报告

## 9. 附录

### 9.1 术语表
- **EARS**: Easy Approach to Requirements Syntax，一种需求描述语法
- **P95**: 95百分位响应时间，表示95%的请求响应时间不超过该值
- **RTO**: Recovery Time Objective，恢复时间目标
- **RPO**: Recovery Point Objective，恢复点目标

### 9.2 参考资料
- [OpenAPI 3.0规范](https://swagger.io/specification/)
- [OWASP测试指南](https://owasp.org/www-project-web-security-testing-guide/)
- [ISO/IEC 25010软件质量标准](https://iso25000.com/index.php/en/iso-25000-standards/iso-25010)