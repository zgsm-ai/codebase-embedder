# /api/v1/search/semantic 接口流程图

## 接口说明
语义搜索接口用于在代码库中执行基于语义的代码搜索，通过向量相似度匹配找到相关的代码片段。

## 请求参数
- `ClientId`: 客户端标识
- `CodebasePath`: 代码库路径
- `Query`: 搜索查询字符串
- `TopK`: 返回结果数量（可选，默认为5）
- `ScoreThreshold`: 分数阈值（可选，用于过滤低相似度结果）

## 接口处理流程

```mermaid
flowchart TD
    A[入口 /codebase-embedder/api/v1/search/semantic<br>POST 方法] --> B[解析请求参数<br>SemanticSearchRequest]
    B --> C[验证必填字段<br>检查ClientId, CodebasePath, Query]
    C --> D{验证是否通过?}
    D -->|否| E[返回参数错误响应]
    D -->|是| F[获取Authorization请求头]
    F --> G{Authorization头是否存在?}
    G -->|否| H[返回认证错误响应]
    G -->|是| I[记录调试日志]
    I --> J[创建语义搜索逻辑实例]
    J --> K[执行语义搜索]
    K --> L[参数预处理<br>设置默认TopK值]
    L --> M[检查查询字符串是否为空]
    M -->|是| N[返回参数错误响应]
    M -->|否| O[预处理查询字符串]
    O --> P[设置追踪上下文]
    P --> Q[调用向量存储查询]
    Q --> R[构建查询选项<br>包含ClientId, CodebasePath等]
    R --> S[执行向量相似度搜索]
    S --> T{查询是否成功?}
    T -->|否| U[返回错误响应]
    T -->|是| V[分数阈值过滤]
    V --> W[遍历搜索结果]
    W --> X{分数是否大于等于阈值?}
    X -->|是| Y[添加到过滤结果列表]
    X -->|否| Z[跳过该结果]
    Y --> AA{是否还有更多结果?}
    Z --> AA
    AA -->|是| W
    AA -->|否| BB[构建响应数据]
    BB --> CC[返回成功响应]
    E --> DD[结束]
    H --> DD
    N --> DD
    U --> DD
    CC --> DD
```

## 详细处理步骤

### 1. 请求解析与验证
- 解析POST请求中的JSON参数
- 验证必填字段：ClientId、CodebasePath、Query
- 检查Authorization请求头是否存在

### 2. 参数预处理
- 设置默认TopK值（最小为1，默认为5）
- 执行查询字符串预处理（去除特殊字符、敏感词过滤等）

### 3. 向量搜索
- 构建查询选项，包含客户端信息和代码库路径
- 调用向量存储服务执行相似度搜索
- 获取基于语义相似度的代码片段列表

### 4. 结果过滤
- 根据ScoreThreshold过滤低相似度结果
- 只保留分数大于等于阈值的代码片段
- 构建最终响应数据

### 5. 响应返回
- 返回过滤后的语义搜索结果列表
- 每个结果包含代码片段信息、相似度分数等

## 错误处理
- **参数错误**: 当必填字段缺失或无效时返回400错误
- **认证错误**: 当Authorization头缺失时返回401错误
- **系统错误**: 当向量搜索服务异常时返回500错误

## 性能考虑
- 向量搜索性能取决于向量数据库的响应速度
- 结果过滤在内存中进行，影响较小
- 建议合理设置TopK值以平衡结果质量和性能